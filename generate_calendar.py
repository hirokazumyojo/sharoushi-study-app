#!/usr/bin/env python3
"""
工藤プロジェクト Swing-by セミナー
Zoom配信日程 & Web配信開始日 → ICSファイル生成スクリプト
"""

from datetime import datetime, timedelta
import uuid

# タイムスロット定義 (JST)
TIME_SLOTS = {
    1: ("09:30", "12:30"),  # ①
    2: ("13:30", "16:30"),  # ②
    3: ("09:30", "12:00"),  # ③
    4: ("13:00", "15:30"),  # ④
    5: ("13:00", "16:00"),  # ⑤
    6: ("10:30", "16:50"),  # ⑥
}

# =============================================================================
# Zoom配信スケジュール (0004.pdf)
# Format: (総回数, 科目名, 日付(YYYY,MM,DD), タイムスロット番号)
# =============================================================================
ZOOM_SCHEDULE = [
    (1,  "社会保障制度の意義と沿革1",         (2025,10,11), 2),
    (2,  "社会保障制度の意義と沿革2",         (2025,10,18), 1),
    (3,  "基本事項の横断1",                   (2025,10,18), 2),
    (4,  "基本事項の横断2",                   (2025,10,25), 1),
    (5,  "基本事項の横断3",                   (2025,10,25), 2),
    (6,  "基本事項の横断4",                   (2025,11,1),  1),
    (7,  "基本事項の横断5",                   (2025,11,1),  2),
    (8,  "基本事項の横断6",                   (2025,11,8),  1),
    (9,  "基本事項の横断7",                   (2025,11,8),  2),
    (10, "健康保険法1",                       (2025,11,15), 1),
    (11, "健康保険法2",                       (2025,11,15), 2),
    (12, "健康保険法3",                       (2025,11,22), 1),
    (13, "健康保険法4",                       (2025,11,22), 2),
    (14, "健康保険法5",                       (2025,11,29), 1),
    (15, "社会保険一般常識1",                 (2025,11,29), 2),
    (16, "社会保険一般常識2",                 (2025,12,6),  1),
    (17, "社会保険一般常識3",                 (2025,12,6),  2),
    (18, "公的年金法1",                       (2025,12,13), 1),
    (19, "公的年金法2",                       (2025,12,13), 2),
    (20, "公的年金法3",                       (2025,12,20), 1),
    (21, "公的年金法4",                       (2025,12,20), 2),
    (22, "公的年金法5",                       (2026,1,10),  1),
    (23, "公的年金法6",                       (2026,1,10),  2),
    (24, "公的年金法7",                       (2026,1,17),  1),
    (25, "公的年金法8",                       (2026,1,17),  2),
    (26, "公的年金法9",                       (2026,1,24),  1),
    (27, "公的年金法10",                      (2026,1,24),  2),
    (28, "労働一般常識1(労働基準関係法令)",    (2026,1,31),  1),
    (29, "労働基準法1",                       (2026,1,31),  2),
    (30, "労働基準法2",                       (2026,2,7),   1),
    (31, "労働基準法3",                       (2026,2,7),   2),
    (32, "労働基準法4",                       (2026,2,14),  1),
    (33, "労働基準法5",                       (2026,2,14),  2),
    (34, "労働基準法6",                       (2026,2,21),  1),
    (35, "労働一般常識2(賃金及び労働時間関係法令)", (2026,2,21), 2),
    (36, "スイングバイ改正法・白書",           (2026,2,28),  1),
    (37, "労働者災害補償保険法1",             (2026,2,28),  2),
    (38, "労働者災害補償保険法2",             (2026,3,7),   1),
    (39, "労働者災害補償保険法3",             (2026,3,7),   2),
    (40, "労働者災害補償保険法4",             (2026,3,14),  1),
    (41, "労働者災害補償保険法5",             (2026,3,14),  2),
    (42, "労働一般常識3(労働市場関係法令)",    (2026,3,21),  1),
    (43, "労働一般常識4(労働市場関係法令)",    (2026,3,21),  2),
    (44, "労働一般常識5(社労士法)",            (2026,3,28),  1),
    (45, "雇用保険法1",                       (2026,3,28),  2),
    (46, "雇用保険法2",                       (2026,4,4),   1),
    (47, "雇用保険法3",                       (2026,4,4),   2),
    (48, "雇用保険法4",                       (2026,4,11),  1),
    (49, "雇用保険法5",                       (2026,4,11),  2),
    (50, "労働保険徴収法1",                   (2026,4,18),  1),
    (51, "労働保険徴収法2",                   (2026,4,18),  2),
    (52, "労働保険徴収法3",                   (2026,4,25),  1),
    (53, "労働安全衛生法1",                   (2026,4,25),  2),
    (54, "労働安全衛生法2",                   (2026,5,9),   1),
    (55, "労働安全衛生法3",                   (2026,5,9),   2),
    (56, "改正法攻略講座1",                   (2026,5,16),  1),
    (57, "改正法攻略講座2",                   (2026,5,16),  2),
    (58, "実戦答練(健康保険)",                (2026,5,23),  3),
    (59, "実戦答練(国民年金)",                (2026,5,23),  4),
    # 60: 第1回公開模試 (別途)
    (61, "実戦答練(厚生年金)",                (2026,6,6),   3),
    (62, "実戦答練(労基・安衛)",              (2026,6,6),   4),
    (63, "実戦答練(労災・徴収)",              (2026,6,13),  3),
    (64, "実戦答練(雇用・徴収)",              (2026,6,13),  4),
    (65, "実戦答練(一般常識)",                (2026,6,20),  3),
    (66, "工藤プロジェクト公開講義",           (2026,6,20),  5),
    # 67: 第2回公開模試 (別途)
    (68, "白書・統計攻略講座1",               (2026,7,4),   1),
    (69, "白書・統計攻略講座2",               (2026,7,4),   2),
    (70, "サマリー編1",                       (2026,7,11),  1),
    (71, "サマリー編2",                       (2026,7,11),  2),
    (72, "サマリー編3",                       (2026,7,18),  1),
    (73, "サマリー編4",                       (2026,7,18),  2),
    # 74: 第3回公開模試 (別途)
]

# 公開模試 (都合のよい1日を選択)
MOCK_EXAMS = [
    ("第1回 公開模試", [(2026,5,29), (2026,5,30), (2026,5,31)], 6),
    ("第2回 公開模試", [(2026,6,26), (2026,6,27), (2026,6,28)], 6),
    ("第3回 公開模試", [(2026,7,24), (2026,7,25), (2026,7,26)], 6),
]

# =============================================================================
# Web配信開始日 (kudou_sche.pdf)
# Format: (回数リスト, 科目名, Web配信開始日(YYYY,MM,DD))
# =============================================================================
WEB_SCHEDULE = [
    # 年金コントラスト/ベイシス (Web/DVD専用)
    ([1],      "年金コントラスト/ベイシス 公的年金の給付と役割及び財政等(1)", (2025,10,6)),
    ([2],      "年金コントラスト/ベイシス 公的年金の給付と役割及び財政等(2)", (2025,10,14)),
    ([3],      "年金コントラスト/ベイシス 公的年金の給付と役割及び財政等(3)", (2025,10,20)),
    ([4],      "年金コントラスト/ベイシス 公的年金の給付と役割及び財政等(4)", (2025,10,27)),
    # ツールボックス編
    ([5],      "社会保障制度の意義と沿革1",     (2025,11,4)),
    ([6],      "社会保障制度の意義と沿革2",     (2025,11,10)),
    ([7,8],    "基本事項の横断1-2",             (2025,11,17)),
    ([9,10],   "基本事項の横断3-4",             (2025,11,25)),
    ([11,12],  "基本事項の横断5-6",             (2025,12,1)),
    ([13],     "基本事項の横断7",               (2025,12,1)),
    # スイングバイ編
    ([14,15],  "健康保険法1-2",                 (2025,12,8)),
    ([16,17],  "健康保険法3-4",                 (2025,12,15)),
    ([18,19],  "健康保険法5 / 社会保険一般常識1", (2025,12,22)),
    ([20,21],  "社会保険一般常識2-3",           (2026,1,5)),
    ([22,23],  "公的年金法1-2",                 (2026,1,13)),
    ([24,25],  "公的年金法3-4",                 (2026,1,19)),
    ([26,27],  "公的年金法5-6",                 (2026,2,2)),
    ([28,29],  "公的年金法7-8",                 (2026,2,9)),
    ([30,31],  "公的年金法9-10",                (2026,2,16)),
    ([32,33],  "労働一般常識1 / 労働基準法1",   (2026,2,24)),
    ([34,35],  "労働基準法2-3",                 (2026,3,2)),
    ([36,37],  "労働基準法4-5",                 (2026,3,9)),
    ([38,39],  "労働基準法6 / 労働一般常識2",   (2026,3,16)),
    ([40,41],  "SW改正白書 / 労災保険法1",      (2026,3,23)),
    ([42,43],  "労災保険法2-3",                 (2026,3,30)),
    ([44,45],  "労災保険法4-5",                 (2026,4,6)),
    ([46,47],  "労働一般常識3-4",               (2026,4,13)),
    ([48,49],  "労働一般常識5 / 雇用保険法1",   (2026,4,20)),
    ([50,51],  "雇用保険法2-3",                 (2026,4,27)),
    ([52,53],  "雇用保険法4-5",                 (2026,5,7)),
    ([54,55],  "労働保険徴収法1-2",             (2026,5,11)),
    ([56,57],  "労働保険徴収法3 / 労働安全衛生法1", (2026,5,18)),
    ([58,59],  "労働安全衛生法2-3",             (2026,6,1)),
    # 直前編
    ([60,61],  "改正法攻略講座1-2",             (2026,5,7)),
    ([62],     "実戦答練1-7",                   (2026,5,7)),
    ([69,70],  "白書・統計攻略講座1-2",         (2026,6,1)),
    ([71],     "工藤プロジェクト公開講義",       (2026,6,8)),
    ([72],     "サマリー編1-4",                 (2026,6,29)),
    # 公開模試(解説講義)
    ([76],     "第1回公開模試 解説講義",         (2026,5,7)),
    ([77],     "第2回公開模試 解説講義",         (2026,6,1)),
    ([78],     "第3回公開模試 解説講義",         (2026,7,6)),
]


def format_dt(year, month, day, time_str):
    """日付と時刻文字列からICS形式のdatetimeを返す"""
    h, m = time_str.split(":")
    dt = datetime(year, month, day, int(h), int(m))
    return dt.strftime("%Y%m%dT%H%M%S")


def format_date(year, month, day):
    """日付からICS形式のdateを返す"""
    return datetime(year, month, day).strftime("%Y%m%d")


def make_vevent(summary, dtstart, dtend, description="", all_day=False, color_tag=""):
    """VEVENTブロックを生成"""
    uid = str(uuid.uuid4())
    now = datetime.now().strftime("%Y%m%dT%H%M%SZ")

    lines = [
        "BEGIN:VEVENT",
        f"UID:{uid}",
        f"DTSTAMP:{now}",
        f"SUMMARY:{summary}",
    ]

    if all_day:
        lines.append(f"DTSTART;VALUE=DATE:{dtstart}")
        lines.append(f"DTEND;VALUE=DATE:{dtend}")
    else:
        lines.append(f"DTSTART;TZID=Asia/Tokyo:{dtstart}")
        lines.append(f"DTEND;TZID=Asia/Tokyo:{dtend}")

    if description:
        # ICSの改行はリテラル \n
        desc_escaped = description.replace("\n", "\\n")
        lines.append(f"DESCRIPTION:{desc_escaped}")

    if color_tag:
        lines.append(f"CATEGORIES:{color_tag}")

    lines.append("END:VEVENT")
    return "\n".join(lines)


def generate_ics():
    """ICSファイルを生成"""

    # VCALENDAR ヘッダー
    vtimezone = """BEGIN:VTIMEZONE
TZID:Asia/Tokyo
BEGIN:STANDARD
DTSTART:19700101T000000
TZOFFSETFROM:+0900
TZOFFSETTO:+0900
TZNAME:JST
END:STANDARD
END:VTIMEZONE"""

    events = []

    # --- Zoom配信イベント ---
    for num, subject, date_tuple, slot in ZOOM_SCHEDULE:
        y, m, d = date_tuple
        start_time, end_time = TIME_SLOTS[slot]
        dtstart = format_dt(y, m, d, start_time)
        dtend = format_dt(y, m, d, end_time)
        summary = f"[Zoom] #{num} {subject}"
        desc = f"工藤プロジェクト Swing-by セミナー\\n第{num}回 {subject}\\nZoom配信"
        events.append(make_vevent(summary, dtstart, dtend, desc, color_tag="Zoom配信"))

    # --- 公開模試イベント ---
    for exam_name, date_options, slot in MOCK_EXAMS:
        start_time, end_time = TIME_SLOTS[slot]
        date_strs = []
        for y, m, d in date_options:
            dt = datetime(y, m, d)
            weekday = ["月","火","水","木","金","土","日"][dt.weekday()]
            date_strs.append(f"{m}/{d}({weekday})")

        # 土曜日のみイベント作成（メイン日程）、他の日は説明に記載
        for y, m, d in date_options:
            dtstart = format_dt(y, m, d, start_time)
            dtend = format_dt(y, m, d, end_time)
            dt = datetime(y, m, d)
            weekday_jp = ["月","火","水","木","金","土","日"][dt.weekday()]
            summary = f"[模試] {exam_name} ({m}/{d} {weekday_jp})"
            desc = (
                f"工藤プロジェクト Swing-by セミナー\\n"
                f"{exam_name}\\n"
                f"日程選択肢: {' / '.join(date_strs)}\\n"
                f"都合のよい1日をお選びください"
            )
            events.append(make_vevent(summary, dtstart, dtend, desc, color_tag="公開模試"))

    # --- Web配信開始イベント ---
    for rows, subject, date_tuple in WEB_SCHEDULE:
        y, m, d = date_tuple
        dtstart = format_date(y, m, d)
        # 終日イベントのDTENDは翌日
        next_day = datetime(y, m, d) + timedelta(days=1)
        dtend = next_day.strftime("%Y%m%d")
        row_str = ",".join(str(r) for r in rows)
        summary = f"[Web配信開始] {subject}"
        desc = (
            f"工藤プロジェクト Swing-by セミナー\\n"
            f"Web動画・音声DL・スマホ配信開始\\n"
            f"対象回: {row_str}"
        )
        events.append(make_vevent(summary, dtstart, dtend, desc, all_day=True, color_tag="Web配信"))

    # ICSファイル組み立て
    ics_content = "\n".join([
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Sharoushi Study App//Kudo Project Schedule//JP",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH",
        "X-WR-CALNAME:工藤プロジェクト Swing-by セミナー",
        "X-WR-TIMEZONE:Asia/Tokyo",
        vtimezone,
        "\n".join(events),
        "END:VCALENDAR",
    ])

    return ics_content


if __name__ == "__main__":
    ics = generate_ics()
    output_path = "/home/user/sharoushi-study-app/kudo_project_schedule.ics"
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(ics)

    # イベント数のサマリー
    zoom_count = len(ZOOM_SCHEDULE)
    mock_count = sum(len(dates) for _, dates, _ in MOCK_EXAMS)
    web_count = len(WEB_SCHEDULE)
    print(f"ICSファイルを生成しました: {output_path}")
    print(f"  Zoom配信: {zoom_count}件")
    print(f"  公開模試: {mock_count}件 (各模試の全日程オプション)")
    print(f"  Web配信開始: {web_count}件")
    print(f"  合計: {zoom_count + mock_count + web_count}件")
